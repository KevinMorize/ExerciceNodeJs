<%- include('../includes/header.ejs')%>

<form class="ui form" href="/user-update" method='post' enctype="multipart/form-data">

  <% if (locals.message) { %>
    <div class="ui red message"><%- locals.message %></div>
  <% } %>

<!-- images -->
<p id="uploadFileLabel">Photo de couverture:</p>
<% if (user.cover) { %>
  <div id="uploadFile">
    <img class="ui avatar middle aligned image" src="tmp/<%= user.cover %>" id="coverInputImg">
    <input type="file" name="cover" accept=".jpg, .jpeg, .png" id="coverInput" onchange="document.getElementById('coverInputImg').src = window.URL.createObjectURL(this.files[0])">
  </div>
<% } else { %>
  <div id="uploadFile">
    <img class="ui avatar middle aligned image" src="img/cover-pic.png" id="coverInputImg">
    <input type="file" name="cover" accept=".jpg, .jpeg, .png" id="coverInput" onchange="document.getElementById('coverInputImg').src = window.URL.createObjectURL(this.files[0])">
  </div>
<% } %>  

<p id="uploadFileLabel">Photo de profil:</p>
<% if (user.userAttachment) { %>
  <div id="uploadFile">
    <img class="ui avatar middle aligned image" src="tmp/<%= user.userAttachment %>" id="profilInputImg">
    <input type="file" name="image" accept=".jpg, .jpeg, .png" onchange="document.getElementById('profilInputImg').src = window.URL.createObjectURL(this.files[0])">
  </div>
<% } else { %> 
  <div id="uploadFile">
    <img class="ui avatar middle aligned image" src="img/profil-pic.png %>" id="profilInputImg">
    <input type="file" name="image" accept=".jpg, .jpeg, .png" onchange="document.getElementById('profilInputImg').src = window.URL.createObjectURL(this.files[0])">
  </div>
<% } %>  

<p>Pseudo:</p>
<div class="field">
    <input type="text" name="username" placeholder="<%= user.username %>" value="<%= user.username %>" minlength="2" maxlength="13" required>
</div>

<p>e-mail:</p>
<div class="field">
  <input type="email" name="email" placeholder="<%= user.email %>" value="<%= user.email %>" required>
</div>

<p>Confimez l'e-mail:</p>
<div class="field">
  <input type="email" name="emailConfirm" value="<%= user.email %>" required>
</div>

<p>Ville ou CP:</p>
<div class="field">
  <input type="text" name="city" placeholder="<%= user.city %>" value="<%= user.city %>" id="citySearch">
  <div id="cityList"></div>
</div>

<p>Bio:</p>
<textarea name="bio" placeholder="ajouter une description" rows="2"><%= user.bio %></textarea>

<button class="ui button" type="submit" id="confirmButton">Modifier l'utilisateur</button>
</form>

<a href="/user-delete" id="deleteButton" onClick="return confirm('Êtes-vous sûr ?')">Supprimer mon compte</a>

<script>

const search = document.getElementById('citySearch');
const matchList = document.getElementById('cityList');

search.addEventListener('keyup', () => searchMarks(search.value));

const searchMarks = async searchText => {
    const res = await fetch('https://api.thedogapi.com/v1/breeds?');
    const breed = await res.json();
    
    let matches = breed.filter(match => {
        const regex = new RegExp(`^${searchText}`, 'gi')
        return match.name.match(regex)
    })

    console.log(matches)

    if (searchText === ""){
      matchList.innerHTML = "";
      matches = [];
    }
    outputHtml(matches);
};

const outputHtml = (matches) => {
    if (matches.length > 0) {
        var html = matches.map(match =>
            `
            <div class="breedMatch" onclick="selectedBreed('${match.name}')">
              ${match.name}
            </div> 
           
            `
        ).join(''); 

        matchList.innerHTML = html;
    };           
}

function selectedBreed (name) {
      search.value = name
      matchList.innerHTML = "";
      matches = [];
}
</script>

<%- include ('../includes/footer.ejs') %>