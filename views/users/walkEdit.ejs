<%- include('../includes/header.ejs')%>

<form class="ui form" href="/walk-create" method='post' id="createWalkForm">

<div id="walkDate">
<p>Séléctionnez une date:</p>
    <div class="walkDateInput">
        <label>le</label>
        <input type="date" name="day" required/>
    </div>

    <div class="walkDateInput">
        <label>de</label>
        <input type="time" name="start" id="start"/>

        <label>à</label>
        <input type="time" name="end" id="end"/>
    </div>
</div>

<p>Ajoutez un lieu de rendez-vous:</p>

<input type="text" name="adress" placeholder="adresse" required>
<div id="walkAdressInput">
    <input type="text" name="zip" placeholder="Code Postal" maxlength="5" required>
    <input type="text" name="city" placeholder="Ville" required>
</div>

<p>Description:</p>
<textarea rows="3" name="description" placeholder="Ajoutez ici des détails sur la balade"></textarea>

<p>Sélectionner mon/mes compagnons:</p>
<div id="addDogs">
    <% dogs.forEach(function(dog) { %>
    <input type="checkbox" id="<%= dog.idDog %>" name="invited" value="<%= dog.idDog %>"/>
    <label for="<%= dog.idDog %>"><img class="ui avatar image" src="tmp/<%= dog.dogAttachment %>" /></label>
    <% }) %>
</div>


<p>Sélectionnez un compagnon à inviter:</p>
<div id="addFriend">
<input type="text" id="search" autocomplete="off" placeholder="Entrez le nom du compagnon"/>
<div id="matchList"></div>
</div>

<div id="selectedArea">
    <% if (locals.query) { %>
        <div class="selectedDiv">
            <img src ="tmp/<%- query.dogAttachment %>" class="ui avatar image" />
            <span><%- query.name %></span>
            <input type="hidden" name="invited" class="hiddenInputMatch" value="<%- query.idDog %>" />
            <button type="button" class="circular ui icon button" onclick= "this.parentNode.parentNode.removeChild(this.parentNode)">
                <i class="close icon"></i>
            </button>
        </div>
    <% } %>
</div>

<button type="submit" class="ui button" id="confirmButton">Confirmer</button>

</form>

<%- include ('../includes/footer.ejs') %>

<script type="text/javascript">

//time
const walkSection = document.getElementById('walkDate');
const start = document.getElementById('start');
const end = document.getElementById('end');

//suggest
const search = document.getElementById('search');
const matchList = document.getElementById('matchList');
const selectedArea = document.getElementById('selectedArea');

//select
const selectedList = document.getElementsByClassName('hiddenInputMatch');

search.addEventListener('focus', () => searchMarks(search.value));
search.addEventListener('input', () => searchMarks(search.value));

matchList.style.display = "none"

const searchMarks = async searchText => {
    const res = await (<%- JSON.stringify(marks) %>);
    
    let matches = res.filter(marks => {
        const regex = new RegExp(`^${searchText}`, 'gi')
        return marks.name.match(regex)
    })

    matchList.style.display = "block"
    outputHtml(matches);
};

const outputHtml = (matches) => {
    if (matches.length > 0) {
        var html = matches.map(match =>
            `
            <div class="ui card" id="verticalCard" class="selectedMatch" value="${match.idDog}" onclick="selectedFriend('${match.dogAttachment}','${match.name}','${match.idDog}')">
                <img class="ui image" src="tmp/${match.dogAttachment}">
                <div class="content">       
                <h4>${match.name}</h4>
                <span class="breed">${match.breed}</span>
                </div>
            </div> 
            `
        ).join(''); 

        matchList.innerHTML = html;
        addMatchTitle()
    };           
}

function addMatchTitle(){
        var title = document.createElement('p')
        matchList.insertBefore(title, matchList.childNodes[0]);
        var titleText = document.createTextNode('Suggestions:')
        title.appendChild(titleText)
}

function selectedFriend(image, name, id) {

    var newMatchDiv = document.createElement('div')
    newMatchDiv.className = "selectedDiv"

    var newMatchImg = document.createElement('img')
    newMatchImg.src = 'tmp/' + image
    newMatchImg.className = 'ui avatar image'
    newMatchDiv.appendChild(newMatchImg)
    selectedArea.appendChild(newMatchDiv)

    var newMatchName = document.createElement('span')
    newMatchDiv.appendChild(newMatchName)
    var name = document.createTextNode(name)
    newMatchName.appendChild(name)

    var newMatchinput = document.createElement('input')
    newMatchinput.type = 'hidden'
    newMatchinput.name = 'invited'
    newMatchinput.className = "hiddenInputMatch"
    newMatchinput.value = id
    newMatchDiv.appendChild(newMatchinput)

    var deleteMatchButton = document.createElement('button')
    deleteMatchButton.type = "button"
    deleteMatchButton.onclick = function(){
        this.parentNode.parentNode.removeChild(this.parentNode)
    }
    deleteMatchButton.className = "circular ui icon button"
    newMatchDiv.appendChild(deleteMatchButton)
    var icoDeleteMatchButton = document.createElement('i')
    icoDeleteMatchButton.className = "close icon"
    deleteMatchButton.appendChild(icoDeleteMatchButton)

    matchList.style.display = "none"
}

$('form').submit(function(e){

    //selectedCHeck
    if(selectedList.length < 2){
        e.preventDefault()
        var message = document.createElement('div')
        message.className = ('ui red message')
        message.id = ('selectErrorMessage')
        selectedArea.appendChild(message)
        var messageText = document.createTextNode("Les balades c'est mieux à deux")
        message.appendChild(messageText)
    }

    // timeCheck
    var startHour = start.value.slice(0, 2)
    var endHour = end.value.slice(0, 2)
    var startMin = start.value.slice(3)
    var endMin = end.value.slice(3)

    if (startHour === "00"){
        var startHour = "24"
    } else if (endHour === "00"){
        var endHour = "24"
    }

    if(startHour && startMin && endHour && endMin && (startHour + startMin >= endHour + endMin)){
        e.preventDefault()
        var message = document.createElement('div')
        message.className = ('ui red message')
        message.id = ('timeErrorMessage')
        walkDate.appendChild(message)
        var messageText = document.createTextNode("L'heure de retour doit être supérieure à l'heure de départ")
        message.appendChild(messageText)
    }
});

</script>